<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Chọn sản phẩm</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    img { width: 50px; height: auto; border-radius: 8px; }
    .footer {
      position: sticky;
      bottom: 0;
      background: #fff;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
    }
    .btn-done .count {
      background: white;
      color: #007bff;
      font-weight: bold;
      padding: 2px 10px;
      border-radius: 999px;
    }
    .search-wrapper {
      position: relative;
    }
    .search-wrapper input {
      padding-right: 35px;
    }
    .clear-btn {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: transparent;
      font-size: 20px;
      line-height: 1;
      color: #999;
      cursor: pointer;
    }
    .clear-btn:hover {
      color: #333;
    }
  </style>
</head>
<body class="p-3">

  <div class="search-bar">
    <input type="text" id="searchInput" class="form-control" placeholder="Tìm sản phẩm..." oninput="renderProducts()" />
    <button onclick="clearSearch()">×</button>
  </div>

  <div id="product-list">Đang tải dữ liệu...</div>

  <div class="footer mt-3">
    <button class="btn btn-outline-primary" onclick="resetAll()">Bỏ chọn</button>
    <a href="summary.html" class="btn btn-primary btn-done">
      Xong <span class="count" id="totalCount">0</span>
    </a>
  </div>

  <script>
    const sheetId = '1aUBO9WsNhh_a3Cqe26qjVirFkMGtHAgg52aPydQoQH4';
    const apiKey = 'AIzaSyDCqMkeIpx-QC7JQ1hJ4_i5Gx4hoNHvGo8';
    const range = 'Sheet1!A2:I';

    let allProducts = [];
    let products = [];

    fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}`)
      .then(res => res.json())
      .then(data => {
        if (!data.values || data.values.length === 0) {
          document.getElementById('product-list').innerText = 'Không có dữ liệu.';
          return;
        }

        allProducts = data.values.map((row, i) => {
          const [maHang, imgUrl, tenSP, tonKhoTong, tonQL1K, donViTinhTong, donViTinhLe, canChuyen, tonKhoQuan] = row;
          return {
            maHang, imgUrl, tenSP, canChuyen, tonKhoQuan,
            tonQL1K: parseInt(tonQL1K || 0),
            qty: 0
          };
        });

        products = [...allProducts];
        renderProducts();
      });

    function renderProducts() {
      const container = document.getElementById('product-list');
      const searchText = document.getElementById('searchInput').value.toLowerCase();

      container.innerHTML = '';

      products = allProducts.filter(p => p.tenSP.toLowerCase().includes(searchText));

      products.forEach((p, i) => {
        container.innerHTML += `
          <div class="row align-items-center mb-3" data-index="${i}">
            <div class="col-auto">
              <img src="${p.imgUrl}" alt="${p.tenSP}" onerror="this.src='https://via.placeholder.com/100x100?text=No+Image'">
            </div>
            <div class="col">
              <div class="fw-bold">${p.tenSP}</div>
              <div class="d-flex justify-content-between align-items-center">
                <div><small>Kho tổng: ${p.tonQL1K}</small></div>
                <div class="d-flex align-items-center gap-2">
                  <div><small>${p.tonKhoQuan}</small></div>
                  <div><small>Cần chuyển: ${p.canChuyen}</small></div>
                  <button class="btn btn-sm btn-primary" onclick="changeQty(${i}, -1)">−</button>
                  <span id="qty-${i}" onclick="enableEditQty(${i})" style="cursor:pointer">${p.qty}</span>
                  <button class="btn btn-sm btn-primary" onclick="changeQty(${i}, 1)">+</button>
                </div>
              </div>
            </div>
          </div>
        `;
      });

      updateTotal();
    }

    function changeQty(index, delta) {
      products[index].qty += delta;
      if (products[index].qty < 0) products[index].qty = 0;
      document.getElementById(`qty-${index}`).innerText = products[index].qty;
      updateTotal();
    }

function enableEditQty(index) {
  const span = document.getElementById(`qty-${index}`);
  const currentQty = span.textContent;

  const input = document.createElement('input');
  input.type = 'number';
  input.value = currentQty;
  input.style.width = '50px';
  input.className = 'form-control form-control-sm';

  input.onblur = () => saveQty(index, input);
  input.onkeydown = (e) => {
    if (e.key === 'Enter') input.blur();
  };

  span.replaceWith(input);
  input.focus();
}

function saveQty(index, inputElem) {
  let qty = parseInt(inputElem.value);
  if (isNaN(qty) || qty < 0) qty = 0;

  products[index].qty = qty;
  const globalIndex = allProducts.findIndex(p => p.maHang === products[index].maHang);
  allProducts[globalIndex].qty = qty;

  const newSpan = document.createElement('span');
  newSpan.id = `qty-${index}`;
  newSpan.textContent = qty;
  newSpan.style.cursor = 'pointer';
  newSpan.onclick = () => enableEditQty(index);

  inputElem.replaceWith(newSpan);

  updateTotal();
}


    function resetAll() {
      products.forEach((p, i) => {
        p.qty = 0;
        const span = document.getElementById(`qty-${i}`);
        if (span) span.textContent = 0;
      });
      allProducts.forEach(p => p.qty = 0);
      updateTotal();
    }

    function updateTotal() {
      const selected = allProducts.filter(p => p.qty > 0).map(p => ({
        maHang: p.maHang,
        tenSP: p.tenSP,
        soLuong: p.qty,
        tonQL1K: p.tonQL1K
      }));

      localStorage.setItem("selectedProducts", JSON.stringify(selected));

      const total = selected.reduce((sum, p) => sum + p.soLuong, 0);
      document.getElementById("totalCount").innerText = total;
    }

    function clearSearch() {
      document.getElementById("searchInput").value = "";
      renderProducts();
    }
  </script>
</body>
</html>
